define(["dojo/Deferred","map/map_config","widgets/StatisticsPane","widgets/WidgetFactory","cluster","table/TableController"],function(e,t,r,a,i,n){var s={};return s.create=function(e){var r=t.features,i=L.esri.Layers.featureLayer(r,{}),n=t.countries,s=L.esri.Layers.featureLayer(n,{}),o=new L.MarkerClusterGroup({singleMarkerMode:!0}),l={cluster:{obj:L.popup(),content:"<div id='{}'></div>",id:"clusterPopup"},marker:{obj:L.popup(),content:"<div class='markerPopup' id='{}'></div>",id:"markerPopup",titleField:"org_name",displayFields:[{field:"org_hq_country",label:"Country"},{field:"org_hq_city",label:"City"},{field:"org_year_founded",label:"Founding Year"},{field:"org_size_id",label:"Size"},{field:"org_type",label:"Organization Type"},{field:"org_url",label:"URL"},{field:"org_description",label:"Description"}],idField:"profile_id"}};o.addTo(e);var u={features:i,countries:s,clusterLayer:o,markers:[],statistics:[]},c=function(e,t){var r=_.pluck(e,"attributes").filter(function(e){return e[t]?!0:void 0});return _.countBy(r,t)},d=function(e){return t.clusterStatFields.map(function(t){return t?{fieldName:t,count:c(e,t)}:!1}).filter(function(e){return e})},p=function(t,r,a){t.obj.setLatLng(r).setContent(t.content.replace("{}",t.id)).openOn(e),a&&new a.constructor(a.props,t.id)},f=function(e,t,r){var a=l.marker,i=a.displayFields.map(function(t){var r={label:t.label,value:e.attributes[t.field]};return r}),n={label:e.attributes[a.titleField],selected:r,toggle:t||!1};return{items:i,title:n,showContent:r,profileID:{value:e.attributes.profile_id}}},b=function(e){var t=l.marker,r=f(e,!1,!0);p(t,e.getLatLng(),{constructor:a.CompanyPopup,props:r})};return o.on("clusterclick",function(e){var t=e.layer.getAllChildMarkers(),r=t.map(function(e){return f(e,!0,!1)}),i=l.cluster,n={companies:r};p(i,e.latlng,{constructor:a.ClusterPopup,props:n})}),u.selectCountries=function(e){s.setWhere(e)},u.updateClusterLayer=function(t){o.clearLayers(),u.markers=t.features.map(function(e){var t=e.geometry,r=new L.marker([t.coordinates[1],t.coordinates[0]]);return r.attributes=e.properties,r.on("click",function(e){b(r)}),r}),u.statistics=d(u.markers),e.updateStatistics({stats:u.statistics,totalCases:u.markers.length});var r=[],a=_.filter(u.markers,function(e){return _.contains(r,e.attributes.profile_id)?!1:(r.push(e.attributes.profile_id),!0)});o.addLayers(a);var i=_.pluck(u.markers,"attributes"),n=_.keys(_.groupBy(i,"data_src_country_locode")).length;e.updateStatistics({stats:u.statistics,totalCases:u.markers.length,totalCountries:n}),u.updateTableData(u.markers)},u.updateTableData=function(e){a.TableResults(u.markers,"tableDiv")},u},s});