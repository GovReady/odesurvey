define(["dojo/Deferred","leaflet","esrileaflet"],function(e){var r={},t=L.esri.Tasks,u=t.query;return r.serviceInfo=function(r){var u=new e;return t.Task.request(r,{f:"json"},function(e){u.resolve(e)}),u},r.uniqueFields=function(r,t,u,n){var i=new e;return L.esri.get(r+"/query",{f:"json",outFields:[t],where:u||"1=1",outStatistics:[{statisticType:"count",onStatisticField:t,outStatisticFieldName:t+"count"}],groupByFieldsForStatistics:n.join(",")},function(e,r){if(e)i.resolve(e);else{var t=_.pluck(r.features,"attributes");i.resolve(t)}}),i},r.getQueryString=function(e){var r=["use_advocacy","use_org_opt","use_other","use_prod_srvc","use_research"],t=[],u=[];return _.forEach(e,function(e){if(_.contains(r,e.fieldName)){var n=("number"===e.valueType?e.value:"'{}'".replace("{}",e.value),[e.fieldName,e.operator,e.value].join(" "));t.push(n)}else{var n=("number"===e.valueType?e.value:"'{}'".replace("{}",e.value),[e.fieldName,e.operator,e.value].join(" "));u.push(n)}}),t.length>0&&u.push("("+t.join(" OR ")+")"),u.join(" AND ")},r.features=function(r,t){var n=new e,i=u({url:r});return _.keys(t).forEach(function(e){i[e](t[e])}),i.run(function(e,r,t){n.resolve(r)}),n},r});